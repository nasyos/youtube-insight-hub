# YouTube Data API v3 クォータ詳細説明

## 📊 クォータとは？

**クォータ（Quota）**とは、APIを使用できる**上限**のことです。YouTube Data API v3では、1日に使用できるAPIリクエストの量が制限されています。

---

## 🔢 クォータの単位

### ユニット（Unit）

YouTube Data API v3では、**ユニット**という単位でクォータを管理します。

- **1ユニット** = APIリクエスト1回分のコスト
- ただし、APIの種類によって、1回のリクエストで消費するユニット数が異なります

---

## 📋 各APIのユニット消費量

### 1. `channels.list` - チャンネル情報取得

**ユニット消費**: **1ユニット/リクエスト**

**使用例**:
```typescript
// @example → channelId に変換
GET https://www.googleapis.com/youtube/v3/channels
  ?part=snippet
  &forUsername=example
  &key=YOUR_API_KEY
```

**説明**: チャンネルハンドル（@example）からチャンネルIDを取得するAPIです。1回のリクエストで1ユニット消費します。

---

### 2. `search.list` - 動画検索

**ユニット消費**: **100ユニット/リクエスト**

**使用例**:
```typescript
// チャンネルの最新動画3件を取得
GET https://www.googleapis.com/youtube/v3/search
  ?part=snippet
  &channelId=UCxxxxx
  &order=date
  &maxResults=3
  &type=video
  &key=YOUR_API_KEY
```

**説明**: チャンネルの最新動画を検索するAPIです。1回のリクエストで**100ユニット**消費します。これは、検索機能が重い処理のため、他のAPIよりも多くのユニットを消費します。

**重要**: `search.list`は最もユニットを消費するAPIです。

---

### 3. `videos.list` - 動画詳細情報取得

**ユニット消費**: **1ユニット/リクエスト**

**使用例**:
```typescript
// VIDEO_IDから詳細情報を取得
GET https://www.googleapis.com/youtube/v3/videos
  ?part=snippet,contentDetails,statistics
  &id=VIDEO_ID1,VIDEO_ID2,VIDEO_ID3
  &key=YOUR_API_KEY
```

**説明**: VIDEO_IDから動画の詳細情報（タイトル、公開日時、サムネイルなど）を取得するAPIです。1回のリクエストで1ユニット消費します。

**注意**: 複数のVIDEO_IDを一度に取得できます（最大50件）。1回のリクエストで複数の動画情報を取得できるため、効率的です。

---

## 📊 実際の使用例

### シナリオ: チャンネル3件をスキャン

#### ステップ1: チャンネルIDを取得（各チャンネル1回）

```
チャンネル1: channels.list → 1ユニット
チャンネル2: channels.list → 1ユニット
チャンネル3: channels.list → 1ユニット
合計: 3ユニット
```

#### ステップ2: 最新動画のVIDEO_IDを取得（各チャンネル1回）

```
チャンネル1: search.list → 100ユニット
チャンネル2: search.list → 100ユニット
チャンネル3: search.list → 100ユニット
合計: 300ユニット
```

#### ステップ3: 動画の詳細情報を取得（全動画を1回のリクエストで取得）

```
動画9件（チャンネル3件 × 動画3件）: videos.list → 1ユニット
合計: 1ユニット
```

#### 合計ユニット消費

```
3 + 300 + 1 = 304ユニット
```

---

## 🎯 1日のクォータ

### デフォルトクォータ

**1日10,000ユニット**

これは、Google Cloud ConsoleでYouTube Data API v3を有効化した時点で自動的に割り当てられるクォータです。

### 1日に何回スキャンできるか？

**計算**:
```
1日のクォータ: 10,000ユニット
1回のスキャン: 約304ユニット（チャンネル3件の場合）

10,000 ÷ 304 ≈ 32.9回

答え: 約32回スキャン可能
```

**注意**: これはチャンネル3件の場合です。チャンネル数や動画数が増えると、1回のスキャンで消費するユニット数も増えます。

---

## 📈 クォータの増加

### クォータを増やす方法

1. **Google Cloud Console**にアクセス
2. 「**APIとサービス**」→「**クォータ**」をクリック
3. 「**YouTube Data API v3**」を選択
4. 必要なクォータをリクエスト

**注意**: クォータの増加は、Googleの承認が必要な場合があります。

---

## ⚠️ クォータ超過時の動作

### クォータを超過した場合

1. **エラーメッセージ**: `403 Quota exceeded`が返されます
2. **APIリクエスト**: すべてのリクエストが拒否されます
3. **回復**: 翌日の0時（UTC）にクォータがリセットされます

### クォータ超過を防ぐ方法

1. **効率的なAPI使用**:
   - `videos.list`で複数のVIDEO_IDを一度に取得
   - 不要なAPIリクエストを避ける

2. **クォータ監視**:
   - Google Cloud Consoleでクォータの使用状況を確認
   - アラートを設定

3. **エラーハンドリング**:
   - クォータ超過エラーを適切に処理
   - ユーザーに分かりやすいメッセージを表示

---

## 📊 クォータ使用量の計算式

### 一般的な計算式

```
1回のスキャン = 
  (チャンネル数 × channels.listのユニット) +
  (チャンネル数 × search.listのユニット) +
  (動画数 × videos.listのユニット ÷ 50)  // 50件ずつ取得可能

例: チャンネル3件、動画3件/チャンネル
  = (3 × 1) + (3 × 100) + (9 ÷ 50 × 1)
  = 3 + 300 + 1
  = 304ユニット
```

**注意**: `videos.list`は最大50件まで一度に取得できるため、動画数が50件以下の場合は1ユニットで済みます。

---

## 🎯 まとめ

### 重要なポイント

1. **ユニット**: APIリクエストのコストを表す単位
2. **search.list**: 最もユニットを消費（100ユニット/リクエスト）
3. **デフォルトクォータ**: 1日10,000ユニット
4. **効率的な使用**: `videos.list`で複数の動画を一度に取得

### 実用的な目安

- **チャンネル3件、動画3件/チャンネル**: 約304ユニット/スキャン
- **1日10,000ユニット**: 約32回スキャン可能
- **クォータ超過**: 翌日の0時（UTC）にリセット

---

## 💡 最適化のヒント

### 1. バッチ処理

```typescript
// ❌ 非効率: 各動画を個別に取得
for (const videoId of videoIds) {
  await getVideoDetails([videoId]); // 9回のリクエスト = 9ユニット
}

// ✅ 効率的: 複数の動画を一度に取得
await getVideoDetails(videoIds); // 1回のリクエスト = 1ユニット
```

### 2. キャッシュの活用

- チャンネルIDは一度取得すれば、データベースに保存して再利用
- 動画の詳細情報も、重複チェック後に保存すれば再利用可能

### 3. 必要な情報のみ取得

- `part`パラメータで必要な情報のみを指定
- 不要な情報を取得しないことで、レスポンス時間を短縮

