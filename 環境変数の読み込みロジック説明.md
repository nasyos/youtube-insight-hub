# 環境変数の読み込みロジック説明

## 📋 Viteでの環境変数の読み込みメカニズム

### 1. 自動読み込みの仕組み

Viteは**自動的に**以下の順序で環境変数ファイルを読み込みます：

1. `.env` - 全環境共通
2. `.env.local` - 全環境共通（gitignoreに含めるべき）
3. `.env.[mode]` - 特定のモード（例: `.env.development`）
4. `.env.[mode].local` - 特定のモードのローカル設定

**重要**: `.env.local`ファイルは開発サーバー起動時に**一度だけ**読み込まれます。

### 2. 環境変数のアクセス方法

Viteでは、**`VITE_`プレフィックス**が付いた環境変数のみがクライアント側（ブラウザ）でアクセス可能です。

```typescript
// ✅ 正しい方法
const apiKey = import.meta.env.VITE_GEMINI_API_KEY;

// ❌ 間違った方法（VITE_がないとブラウザでアクセスできない）
const apiKey = import.meta.env.GEMINI_API_KEY; // undefinedになる
```

### 3. 現在のコードでの読み込み箇所

#### `lib/supabase.ts` (4-5行目)
```typescript
const supabaseUrl = (import.meta as any).env?.VITE_SUPABASE_URL || '';
const supabaseAnonKey = (import.meta as any).env?.VITE_SUPABASE_ANON_KEY || '';
```

#### `services/geminiService.ts` (9行目)
```typescript
const apiKey = (import.meta as any).env?.VITE_GEMINI_API_KEY || (import.meta as any).env?.GEMINI_API_KEY;
```

#### `services/apiService.ts` (4-7行目)
```typescript
const API_BASE_URL = (import.meta as any).env?.VITE_API_BASE_URL || '/api';
const supabaseUrl = (import.meta as any).env?.VITE_SUPABASE_URL || '';
const supabaseAnonKey = (import.meta as any).env?.VITE_SUPABASE_ANON_KEY || '';
```

### 4. 読み込みのタイミング

```
開発サーバー起動
    ↓
Viteが.env.localを読み込む
    ↓
import.meta.envに環境変数を注入
    ↓
アプリケーションコードが実行される
    ↓
各サービスで環境変数を読み込む
```

**重要**: `.env.local`を変更したら、**必ず開発サーバーを再起動**する必要があります。

### 5. デバッグ方法

実際に環境変数が読み込まれているか確認するには：

```typescript
// 開発環境でのみ実行
if (import.meta.env.DEV) {
  console.log('🔍 全環境変数:', import.meta.env);
  console.log('🔍 VITE_GEMINI_API_KEY:', import.meta.env.VITE_GEMINI_API_KEY);
}
```

---

## 🔧 問題の原因と解決方法

### 問題: 環境変数が読み込まれない

**考えられる原因**:
1. 開発サーバーを再起動していない
2. `.env.local`ファイルの形式が間違っている
3. `VITE_`プレフィックスがない
4. ファイルが正しい場所にない（`package.json`と同じディレクトリ）

**解決方法**:
1. `.env.local`ファイルを確認
2. 開発サーバーを完全に停止（Ctrl+C）
3. `npm run dev`で再起動
4. ブラウザをリロード（F5）

---

## 📝 現在の実装の問題点

現在のコードでは`(import.meta as any).env`としているため、TypeScriptの型チェックが効いていません。

より良い実装:
```typescript
// vite-env.d.ts で型定義を追加
interface ImportMetaEnv {
  readonly VITE_GEMINI_API_KEY: string;
  readonly VITE_SUPABASE_URL: string;
  readonly VITE_SUPABASE_ANON_KEY: string;
}

// コード内で
const apiKey = import.meta.env.VITE_GEMINI_API_KEY;
```

