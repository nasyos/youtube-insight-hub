# YouTube Insight Hub - 作業手順書

## 1. プロジェクト概要

### 1.1 システムの目的
YouTubeチャンネルの最新動画を自動的に取得し、AI（Gemini）で要約して、Webページで閲覧可能にし、Google Chatなどに配信するシステムです。

### 1.2 主要機能
- **YouTube動画取得**: 最新動画の自動取得
- **チャンネル管理**: 監視するチャンネルの追加・削除
- **AI要約**: Gemini AIによる動画内容の要約と重要ポイント抽出
- **Web表示**: 要約結果のダッシュボード表示
- **Google連携**: Googleドキュメントへの自動保存
- **配信機能**: Google Chatへの通知（Webhook経由）
- **自動化**: 定期的なクローリングまたはWebhookによる自動連携

### 1.3 技術スタック
- **フロントエンド**: React 19.2.3 + TypeScript + Vite
- **AI**: Google Gemini API (gemini-3-flash-preview)
- **ストレージ**: LocalStorage（ブラウザ）
- **デプロイ**: Vercel
- **自動化**: Google Apps Script（GAS）

---

## 2. システムアーキテクチャ

### 2.1 ファイル構成
```
youtube-insight-hub/
├── App.tsx                    # メインアプリケーションコンポーネント
├── types.ts                   # TypeScript型定義
├── components/
│   ├── ChannelItem.tsx        # チャンネル表示コンポーネント
│   └── SummaryCard.tsx        # 要約カード表示コンポーネント
├── services/
│   ├── geminiService.ts       # Gemini AI連携サービス
│   ├── googleApiService.ts    # Google API連携サービス
│   └── gasGeneratorService.ts # GASスクリプト生成サービス
├── package.json               # 依存関係
├── vite.config.ts            # Vite設定
└── vercel.json               # Vercel設定
```

### 2.2 データフロー
```
1. ユーザーがチャンネルを追加
   ↓
2. GeminiService.findChannel() でチャンネル情報を取得
   ↓
3. ユーザーが「最新をチェック」ボタンをクリック
   ↓
4. GeminiService.scanChannel() で最新動画を取得・要約
   ↓
5. VideoSummary[] が生成され、LocalStorageに保存
   ↓
6. Webページに要約カードとして表示
   ↓
7. （オプション）Googleドキュメントに保存
   ↓
8. （オプション）Google Chatに通知
```

### 2.3 主要データ構造

#### VideoSummary
```typescript
{
  id: string;              // 一意のID
  title: string;           // 動画タイトル
  publishedAt: string;     // 公開日
  thumbnailUrl: string;    // サムネイルURL
  summary: string;         // 要約文（200文字程度）
  keyPoints: string[];     // 重要なポイント（3つ）
  channelId: string;       // チャンネルID
  channelTitle: string;    // チャンネル名
  url: string;             // 動画URL
  docUrl?: string;         // Google Doc URL（保存後）
}
```

#### TrackedChannel
```typescript
{
  id: string;              // 一意のID
  name: string;            // チャンネル名
  handle: string;          // @ハンドル
  lastChecked: string;      // 最終チェック日時
  thumbnailUrl: string;    // チャンネルアイコンURL
}
```

---

## 3. 実装済み機能

### 3.1 チャンネル管理機能
**実装場所**: `App.tsx` (100-118行目)

- **チャンネル追加**: チャンネル名または@ハンドルで検索して追加
- **チャンネル表示**: サイドバーに監視中のチャンネル一覧を表示
- **チャンネル削除**: ホバー時に削除ボタンが表示される

**実装詳細**:
- `GeminiService.findChannel()` を使用してチャンネル情報を取得
- LocalStorage (`yt_insight_channels`) に保存
- `ChannelItem` コンポーネントで表示

### 3.2 動画取得・要約機能
**実装場所**: `services/geminiService.ts` (16-73行目)

- **最新動画取得**: チャンネルの最新動画3件を取得
- **AI要約**: Gemini AIで動画内容を要約（200文字程度）
- **重要ポイント抽出**: 3つの重要ポイントを抽出

**実装詳細**:
- `gemini-3-flash-preview` モデルを使用
- Google Search grounding機能でリアルタイムデータを取得
- JSON形式で構造化されたデータを返却

### 3.3 Web表示機能
**実装場所**: `App.tsx` (203-229行目), `components/SummaryCard.tsx`

- **ダッシュボード表示**: 要約カードをグリッド形式で表示
- **レスポンシブデザイン**: モバイル・タブレット・デスクトップ対応
- **動画リンク**: カードから直接YouTube動画にアクセス可能

**実装詳細**:
- LocalStorage (`yt_insight_summaries`) から要約データを読み込み
- 最大50件まで保持
- 重複チェック機能あり（タイトルで判定）

### 3.4 Google連携機能
**実装場所**: `services/googleApiService.ts`

- **OAuth認証**: Google Client IDを使用した認証
- **Googleドキュメント作成**: 要約をGoogleドキュメントとして保存
- **フォルダ管理**: 「YouTube Insight Hub」フォルダに自動整理

**実装詳細**:
- OAuth 2.0 トークンフロー（Implicit Grant）
- Google Drive API / Google Docs API を使用
- セッションストレージにトークンを保存

### 3.5 手動スキャン機能
**実装場所**: `App.tsx` (78-98行目)

- **一括スキャン**: 登録済みチャンネルを一括でスキャン
- **進捗表示**: スキャン中の状態を表示

---

## 4. 未実装・要実装機能

### 4.1 定期クローリング機能
**現状**: 手動ボタンクリックのみ。自動化は未実装。

**必要な実装**:
1. **バックエンドAPIエンドポイントの作成**
   - 定期的にチャンネルをスキャンするエンドポイント
   - Vercel Serverless Functions または別のバックエンドサービス

2. **スケジューラー設定**
   - Vercel Cron Jobs または外部サービス（GitHub Actions等）
   - 設定可能な間隔（例: 1時間ごと、6時間ごと）

3. **実装例（Vercel Serverless Function）**:
```typescript
// api/cron/scan-channels.ts
export default async function handler(req, res) {
  // LocalStorageの代わりにデータベースからチャンネル一覧を取得
  // GeminiServiceでスキャン実行
  // 新しい動画があれば要約を生成
  // データベースに保存
}
```

### 4.2 Webhook機能
**現状**: 未実装。YouTube PubSubHubbub等のWebhook受信機能がない。

**必要な実装**:
1. **Webhookエンドポイントの作成**
   - YouTube PubSubHubbub の受信エンドポイント
   - または独自のWebhook形式

2. **実装例**:
```typescript
// api/webhook/youtube.ts
export default async function handler(req, res) {
  if (req.method === 'POST') {
    // YouTubeからの通知を処理
    // 新しい動画IDを取得
    // GeminiServiceで要約生成
    // データベースに保存
    // Google Chatに通知
  }
}
```

3. **YouTube PubSubHubbub設定**
   - YouTube Data API v3 でチャンネルを購読
   - Webhook URLを登録

### 4.3 Google Chat配信機能
**現状**: `gasGeneratorService.ts` でGASスクリプトを生成するのみ。実際の配信機能は未実装。

**必要な実装**:
1. **Google Chat Webhook送信機能**
   - `googleConfig.chatWebhookUrl` を使用
   - 新しい要約が生成されたときに自動送信

2. **実装場所**: `App.tsx` の `scanAllChannels` 関数内、または新しい要約が追加されたとき

3. **実装例**:
```typescript
async function sendToGoogleChat(summary: VideoSummary, docUrl?: string) {
  if (!googleConfig.chatWebhookUrl) return;
  
  const payload = {
    text: `🔔 *新しい動画の要約*\n\n*タイトル:* ${summary.title}\n*チャンネル:* ${summary.channelTitle}\n📄 *Doc:* ${docUrl || '未保存'}\n📺 *Video:* ${summary.url}`
  };
  
  await fetch(googleConfig.chatWebhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}
```

### 4.4 データベース連携
**現状**: LocalStorageのみ。ブラウザ依存で、複数デバイス間で同期不可。

**必要な実装**:
1. **データベース選択**
   - Vercel Postgres
   - Supabase
   - Firebase Firestore
   - その他のデータベースサービス

2. **データ移行**
   - LocalStorageからデータベースへの移行機能
   - 既存データのインポート機能

3. **API実装**
   - チャンネル一覧取得API
   - 要約一覧取得API
   - チャンネル追加API
   - 要約保存API

---

## 5. 実装手順

### 5.1 定期クローリング機能の実装

#### ステップ1: Vercel Serverless Functionの作成
1. `api/cron/scan-channels.ts` を作成
2. 環境変数からGEMINI_API_KEYを取得
3. データベースからチャンネル一覧を取得
4. 各チャンネルをスキャン
5. 新しい動画があれば要約を生成して保存

#### ステップ2: Vercel Cron Jobsの設定
1. `vercel.json` にcron設定を追加:
```json
{
  "crons": [{
    "path": "/api/cron/scan-channels",
    "schedule": "0 * * * *"
  }]
}
```

#### ステップ3: データベース連携
1. データベースサービスを選択・設定
2. チャンネル・要約データのスキーマ定義
3. API関数でデータベース操作を実装

### 5.2 Webhook機能の実装

#### ステップ1: Webhookエンドポイントの作成
1. `api/webhook/youtube.ts` を作成
2. YouTube PubSubHubbubの検証処理を実装
3. 通知受信時の処理を実装

#### ステップ2: YouTube Data API設定
1. Google Cloud ConsoleでYouTube Data API v3を有効化
2. PubSubHubbubでチャンネルを購読
3. Webhook URLを登録

#### ステップ3: 通知処理の実装
1. 動画IDから動画情報を取得
2. GeminiServiceで要約生成
3. データベースに保存
4. Google Chatに通知

### 5.3 Google Chat配信機能の実装

#### ステップ1: Google Chat Webhook URLの取得
1. Google ChatスペースでWebhook URLを生成
2. `googleConfig.chatWebhookUrl` に保存

#### ステップ2: 送信機能の実装
1. `App.tsx` に `sendToGoogleChat` 関数を追加
2. 新しい要約が生成されたときに自動送信
3. エラーハンドリングを実装

#### ステップ3: 自動送信の有効化
1. `googleConfig.autoExport` フラグを活用
2. 設定UIで自動送信のON/OFFを切り替え可能に

### 5.4 データベース連携の実装

#### ステップ1: データベースサービスの選択と設定
1. Vercel Postgres または Supabase を推奨
2. 環境変数に接続情報を設定

#### ステップ2: スキーマ定義
```sql
-- channels テーブル
CREATE TABLE channels (
  id VARCHAR PRIMARY KEY,
  name VARCHAR NOT NULL,
  handle VARCHAR NOT NULL,
  last_checked TIMESTAMP,
  thumbnail_url VARCHAR
);

-- summaries テーブル
CREATE TABLE summaries (
  id VARCHAR PRIMARY KEY,
  title VARCHAR NOT NULL,
  published_at TIMESTAMP,
  thumbnail_url VARCHAR,
  summary TEXT,
  key_points JSONB,
  channel_id VARCHAR,
  channel_title VARCHAR,
  url VARCHAR,
  doc_url VARCHAR,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### ステップ3: API関数の実装
1. `api/channels.ts`: チャンネル一覧取得・追加
2. `api/summaries.ts`: 要約一覧取得・保存
3. `App.tsx` を修正してAPI経由でデータ取得

---

## 6. 環境変数設定

### 6.1 必要な環境変数
```
GEMINI_API_KEY=your_gemini_api_key_here
DATABASE_URL=your_database_connection_string (データベース使用時)
GOOGLE_CLIENT_ID=your_google_client_id (フロントエンドで設定)
```

### 6.2 環境変数の設定場所
- **ローカル開発**: `.env.local` ファイル
- **Vercel**: プロジェクト設定 → Environment Variables

---

## 7. Google Cloud Console設定

### 7.1 必要なAPIの有効化
1. **Google Drive API**: ドキュメント作成用
2. **Google Docs API**: ドキュメント編集用
3. **YouTube Data API v3**: Webhook機能使用時

### 7.2 OAuth 2.0 クライアントID設定
1. Google Cloud Console → 認証情報
2. OAuth 2.0 クライアントIDを作成
3. 承認済みのJavaScript生成元: `https://your-domain.vercel.app`
4. 承認済みのリダイレクトURI: `https://your-domain.vercel.app`

---

## 8. テスト手順

### 8.1 ローカルテスト
1. `npm install` で依存関係をインストール
2. `.env.local` に `GEMINI_API_KEY` を設定
3. `npm run dev` で開発サーバー起動
4. ブラウザで `http://localhost:3000` にアクセス
5. チャンネル追加 → スキャン実行 → 要約表示を確認

### 8.2 デプロイテスト
1. Vercelにデプロイ
2. 環境変数を設定
3. Google Client IDを設定して認証テスト
4. チャンネル追加・スキャン・要約表示を確認

### 8.3 自動化テスト
1. Cron Jobが正しく実行されるか確認
2. Webhookが正しく受信されるか確認
3. Google Chatへの通知が正しく送信されるか確認

---

## 9. トラブルシューティング

### 9.1 よくある問題

#### Gemini API エラー
- **原因**: APIキーが無効またはクォータ超過
- **解決**: APIキーを再確認、クォータを確認

#### Google認証エラー（403）
- **原因**: OAuth設定が正しくない、テストユーザー未追加
- **解決**: `App.tsx` のヘルプモーダルを参照、設定を再確認

#### 要約が生成されない
- **原因**: Gemini APIのレスポンスエラー、ネットワークエラー
- **解決**: コンソールログを確認、APIキーを確認

#### LocalStorageの制限
- **原因**: ブラウザのLocalStorage容量制限（約5-10MB）
- **解決**: データベースに移行

---

## 10. 今後の拡張案

### 10.1 機能拡張
- **複数言語対応**: 要約を複数言語で生成
- **カテゴリ分類**: 動画をカテゴリで分類
- **検索機能**: 要約内容で検索
- **フィルター機能**: チャンネル・日付でフィルター
- **エクスポート機能**: CSV/JSON形式でエクスポート

### 10.2 パフォーマンス改善
- **キャッシュ機能**: 要約結果をキャッシュ
- **バッチ処理**: 複数チャンネルを並列処理
- **ページネーション**: 要約一覧のページ分割

### 10.3 セキュリティ強化
- **認証機能**: ユーザー認証の追加
- **レート制限**: API呼び出しのレート制限
- **データ暗号化**: 機密データの暗号化

---

## 11. 参考資料

### 11.1 APIドキュメント
- [Gemini API Documentation](https://ai.google.dev/docs)
- [Google Drive API Documentation](https://developers.google.com/drive/api)
- [Google Docs API Documentation](https://developers.google.com/docs/api)
- [YouTube Data API v3 Documentation](https://developers.google.com/youtube/v3)
- [Vercel Serverless Functions](https://vercel.com/docs/functions)

### 11.2 関連サービス
- [Vercel Cron Jobs](https://vercel.com/docs/cron-jobs)
- [Google Chat Webhooks](https://developers.google.com/chat/api/guides/message-formats/basic)
- [YouTube PubSubHubbub](https://developers.google.com/youtube/v3/guides/push_notifications)

---

## 12. まとめ

### 12.1 現在の実装状況
- ✅ チャンネル管理機能
- ✅ 動画取得・要約機能
- ✅ Web表示機能
- ✅ Google連携機能（ドキュメント保存）
- ⚠️ 定期クローリング（手動のみ、自動化未実装）
- ❌ Webhook機能（未実装）
- ⚠️ Google Chat配信（GASスクリプト生成のみ、実際の送信未実装）
- ⚠️ データベース連携（LocalStorageのみ）

### 12.2 優先実装項目
1. **データベース連携**: 複数デバイス対応のため最優先
2. **定期クローリング**: 自動化の核心機能
3. **Google Chat配信**: 通知機能の完成
4. **Webhook機能**: リアルタイム通知の実現

---

**作成日**: 2024年
**バージョン**: 1.0

