# リスク分析：現状評価とリスクシナリオ

## 🚨 リスクレベル評価

### **総合リスクレベル: 中〜高**

| リスクカテゴリ | レベル | 緊急度 | 影響範囲 |
|--------------|--------|--------|----------|
| **コスト関連** | 🔴 **高** | **高** | 金銭的損失 |
| **APIクォータ枯渇** | 🔴 **高** | **高** | サービス停止 |
| **データ整合性** | 🟡 **中** | 中 | データ破損 |
| **サービス可用性** | 🟡 **中** | 中 | サービス停止 |
| **情報漏洩** | 🟢 **低** | 低 | 限定的 |

---

## 💰 コスト関連リスク（最優先）

### **リスクレベル: 🔴 高**

#### **シナリオ1: 悪意のある大量リクエストによるAPIコストの発生**

**攻撃方法:**
```bash
# 攻撃者がスクリプトで大量リクエストを送信
for i in {1..1000}; do
  curl -X POST https://your-app.vercel.app/api/youtube/jobs/process \
    -H "Content-Type: application/json" \
    -d '{"limit": 10}'
done
```

**影響:**
- **Gemini APIコスト**: 1リクエストあたり約$0.001〜$0.01（モデルによる）
  - 1000リクエスト = **$1〜$10**
  - 1日1000リクエスト = **月額$30〜$300**
- **YouTube APIクォータ**: 1リクエストあたり1〜5ユニット
  - 1000リクエスト = **1,000〜5,000ユニット**
  - デフォルトクォータ: 10,000ユニット/日
  - **1日でクォータ枯渇の可能性**

**現在の対策:**
- ❌ 認証なし（誰でも呼び出せる）
- ❌ レート制限なし
- ❌ IP制限なし

**対策の緊急度: 🔴 非常に高い**

---

#### **シナリオ2: ポーリングエンドポイントの悪用**

**攻撃方法:**
```bash
# 攻撃者が大量のポーリングリクエストを送信
for i in {1..100}; do
  curl -X POST https://your-app.vercel.app/api/youtube/poll \
    -H "Content-Type: application/json" \
    -d '{"maxResults": 50}'
done
```

**影響:**
- **YouTube APIクォータ**: 
  - `channels.list`: 1ユニット/リクエスト
  - `playlistItems.list`: 1ユニット/リクエスト
  - `videos.list`: 1ユニット/リクエスト
  - 100リクエスト × 3API = **300ユニット**
  - 複数チャンネル登録時: **さらに増加**
- **データベース負荷**: 大量の書き込み処理
- **Vercelの実行時間**: 無料プランは100秒/リクエスト制限
  - 大量リクエストで**制限超過の可能性**

**現在の対策:**
- ❌ 認証なし
- ❌ レート制限なし
- ⚠️ データベースのRLS未設定

**対策の緊急度: 🔴 非常に高い**

---

## 🔥 APIクォータ枯渇リスク

### **リスクレベル: 🔴 高**

#### **シナリオ3: YouTube APIクォータの枯渇**

**攻撃方法:**
```bash
# 攻撃者が短時間で大量リクエスト
while true; do
  curl -X POST https://your-app.vercel.app/api/youtube/poll
  sleep 0.1
done
```

**影響:**
- **YouTube API**: デフォルトクォータ 10,000ユニット/日
- **クォータ枯渇後**: 
  - 正常なユーザーがAPIを使用できない
  - サービスが完全に停止
  - クォータリセットまで待つ必要（24時間）

**現在の対策:**
- ❌ レート制限なし
- ❌ 認証なし
- ⚠️ クォータ監視なし

**対策の緊急度: 🔴 非常に高い**

---

#### **シナリオ4: Gemini APIクォータの枯渇**

**攻撃方法:**
```bash
# 要約ジョブ処理を大量に実行
for i in {1..500}; do
  curl -X POST https://your-app.vercel.app/api/youtube/jobs/process \
    -H "Content-Type: application/json" \
    -d '{"limit": 50}'
done
```

**影響:**
- **Gemini API**: 利用プランに応じて制限あり
  - 無料プラン: 15 RPM（1分間に15リクエスト）
  - 有料プラン: プランによる
- **クォータ超過後**:
  - エラーが発生
  - 正常な処理ができなくなる
  - **コストが発生する可能性**（有料プランの場合）

**現在の対策:**
- ❌ レート制限なし
- ❌ 認証なし
- ⚠️ クォータ監視なし

**対策の緊急度: 🔴 非常に高い**

---

## 🗄️ データ整合性リスク

### **リスクレベル: 🟡 中**

#### **シナリオ5: 不正なWebSub購読**

**攻撃方法:**
```bash
# 攻撃者が任意のチャンネルを購読
curl -X POST https://your-app.vercel.app/api/youtube/websub/subscribe \
  -H "Content-Type: application/json" \
  -d '{"channelId": "UCxxxxx"}'
```

**影響:**
- **データベース汚染**: 不正なチャンネルが登録される
- **不要な通知**: 関係のないチャンネルの通知が届く
- **リソース消費**: 不要な処理が実行される

**現在の対策:**
- ❌ 認証なし
- ⚠️ チャンネルIDの検証はあるが、登録済みチャンネルのみという制限なし

**対策の緊急度: 🟡 中**

---

#### **シナリオ6: WebSub Callbackへの偽の通知**

**攻撃方法:**
```bash
# 攻撃者が偽のAtom XMLを送信
curl -X POST https://your-app.vercel.app/api/youtube/websub/callback \
  -H "Content-Type: application/xml" \
  -d '<?xml version="1.0"?>
<feed>
  <entry>
    <yt:videoId>fake_video_id</yt:videoId>
    <yt:channelId>fake_channel_id</yt:channelId>
  </entry>
</feed>'
```

**影響:**
- **データベース汚染**: 偽の動画データが登録される
- **要約ジョブの無駄な実行**: 存在しない動画の要約を試みる
- **リソース消費**: 無駄な処理が実行される

**現在の対策:**
- ⚠️ 購読済みチャンネルの検証が不十分
- ⚠️ リクエスト元の検証なし

**対策の緊急度: 🟡 中**

---

## 🌐 サービス可用性リスク

### **リスクレベル: 🟡 中**

#### **シナリオ7: DDoS攻撃（分散サービス拒否攻撃）**

**攻撃方法:**
```bash
# 複数のIPから同時に大量リクエスト
# ボットネットを使用して攻撃
```

**影響:**
- **Vercelの制限超過**: 
  - 無料プラン: 100GB帯域幅/月
  - 実行時間: 100秒/リクエスト
- **サービス停止**: 正常なユーザーがアクセスできない
- **コスト増加**: 有料プランに移行が必要になる可能性

**現在の対策:**
- ❌ レート制限なし
- ❌ IP制限なし
- ⚠️ Vercelの基本的なDDoS保護はあるが、完全ではない

**対策の緊急度: 🟡 中**

---

## 📊 リスクシナリオまとめ

| シナリオ | リスクレベル | 緊急度 | 影響 | 対策の難易度 |
|---------|------------|--------|------|------------|
| **シナリオ1**: 大量リクエストによるコスト発生 | 🔴 高 | 🔴 高 | 金銭的損失 | 🟢 低（APIキー認証） |
| **シナリオ2**: ポーリングエンドポイントの悪用 | 🔴 高 | 🔴 高 | APIクォータ枯渇 | 🟢 低（APIキー認証） |
| **シナリオ3**: YouTube APIクォータ枯渇 | 🔴 高 | 🔴 高 | サービス停止 | 🟢 低（認証+レート制限） |
| **シナリオ4**: Gemini APIクォータ枯渇 | 🔴 高 | 🔴 高 | サービス停止 | 🟢 低（認証+レート制限） |
| **シナリオ5**: 不正なWebSub購読 | 🟡 中 | 🟡 中 | データ汚染 | 🟢 低（APIキー認証） |
| **シナリオ6**: 偽のWebSub通知 | 🟡 中 | 🟡 中 | データ汚染 | 🟡 中（購読検証強化） |
| **シナリオ7**: DDoS攻撃 | 🟡 中 | 🟡 中 | サービス停止 | 🟡 中（レート制限） |

---

## ⚡ すぐに対策できる危険度

### **🔴 非常に高い（すぐに対策が必要）**

1. **APIキー認証の実装**
   - **難易度**: 🟢 低（30分〜1時間）
   - **効果**: シナリオ1, 2, 3, 4, 5を防ぐ
   - **実装内容**:
     ```typescript
     // 各エンドポイントに追加
     const apiKey = req.headers.get('X-API-Key');
     if (apiKey !== process.env.API_KEY) {
       return new Response('Unauthorized', { status: 401 });
     }
     ```

2. **レート制限の実装**
   - **難易度**: 🟡 中（1〜2時間）
   - **効果**: シナリオ3, 4, 7を防ぐ
   - **実装内容**: Upstash Redisまたは簡易版のメモリベース

### **🟡 中（できるだけ早く）**

3. **CORS設定の改善**
   - **難易度**: 🟢 低（15分）
   - **効果**: CSRF攻撃の防止

4. **WebSub Callbackの検証強化**
   - **難易度**: 🟡 中（30分）
   - **効果**: シナリオ6を防ぐ

---

## 🎯 推奨アクション

### **今すぐ実行（1時間以内）**

1. ✅ **APIキー認証を実装**
   - `/api/youtube/poll`
   - `/api/youtube/jobs/process`
   - `/api/youtube/websub/subscribe`
   - `/api/youtube/websub/resubscribe`

2. ✅ **環境変数`API_KEY`を設定**
   - Vercelダッシュボードで設定
   - 強力なランダム文字列を生成

### **今日中に実行（2〜3時間）**

3. ✅ **レート制限の実装**
   - 簡易版（メモリベース）でも可
   - 本番環境ではUpstash Redisを推奨

4. ✅ **CORS設定の改善**
   - 許可するオリジンを限定

### **今週中に実行**

5. ✅ **WebSub Callbackの検証強化**
   - 購読済みチャンネルのみ受け入れる

6. ✅ **ログ監視の実装**
   - 異常なリクエストの検知

---

## 💡 結論

### **現状のリスクレベル**

- **コスト関連**: 🔴 **高** - すぐに対策が必要
- **APIクォータ**: 🔴 **高** - すぐに対策が必要
- **データ整合性**: 🟡 **中** - できるだけ早く対策
- **サービス可用性**: 🟡 **中** - できるだけ早く対策

### **すぐに対策できる危険度**

**はい、すぐに対策できます。**

1. **APIキー認証**: 30分〜1時間で実装可能
2. **レート制限**: 1〜2時間で実装可能（簡易版）

これらの対策を実装すれば、**最も深刻なリスク（コスト発生、APIクォータ枯渇）を大幅に軽減できます。**

### **推奨順序**

1. **最優先**: APIキー認証（今すぐ）
2. **次**: レート制限（今日中）
3. **その後**: CORS改善、WebSub検証強化

---

## 📝 補足：Vercelデプロイ前のリスク

**ローカル環境では:**
- リスクは**低**（外部からアクセスできない）
- ただし、Vercelデプロイ後は**即座にリスクが高くなる**

**推奨:**
- Vercelデプロイ**前**にAPIキー認証を実装
- デプロイ後、すぐに環境変数を設定

