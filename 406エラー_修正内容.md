# 406エラー修正内容

## 🔍 エラーの原因

コンソールに以下のエラーが表示されていました：
```
GET https://vgscuhunmcpozsjlorfh.supabase.co/rest/v1/summaries?select=id&video_url...
406 (Not Acceptable)
```

### 原因1: `.single()` の使用

`saveSummary` メソッドで重複チェックを行っている際に、`.single()` を使用していました。`.single()` は、結果が1件であることを期待しますが、結果が0件の場合にエラーを返す可能性があります。

### 原因2: Acceptヘッダーの不足

SupabaseのREST APIは、`Accept: application/json` ヘッダーを要求する場合があります。Supabaseクライアントは通常自動的に設定しますが、明示的に設定することで確実にします。

---

## 🛠️ 実施した修正

### 修正1: `.single()` を `.maybeSingle()` に変更

**ファイル**: `services/apiService.ts`

**変更前**:
```typescript
const { data: existing } = await supabase
  .from('summaries')
  .select('id')
  .eq('video_url', summary.url)
  .single();
```

**変更後**:
```typescript
const { data: existingData, error: checkError } = await supabase
  .from('summaries')
  .select('id')
  .eq('video_url', summary.url)
  .maybeSingle(); // .single()の代わりに.maybeSingle()を使用（0件でもエラーにならない）

// エラーが発生した場合でも、新規作成を試みる（重複チェックは警告のみ）
if (checkError && checkError.code !== 'PGRST116') { // PGRST116は「結果が見つからない」エラー（正常）
  console.warn('重複チェックエラー（無視して続行）:', checkError);
}

const existing = existingData;
```

**効果**:
- `.maybeSingle()` は、結果が0件でもエラーを返しません
- 結果が0件の場合は `null` を返します
- 結果が1件の場合は、そのデータを返します

### 修正2: SupabaseクライアントにAcceptヘッダーを明示的に設定

**ファイル**: `lib/supabase.ts`

**変更前**:
```typescript
export const supabase = supabaseUrl && supabaseAnonKey
  ? createClient(supabaseUrl, supabaseAnonKey)
  : createClient('https://placeholder.supabase.co', 'placeholder-key');
```

**変更後**:
```typescript
export const supabase = supabaseUrl && supabaseAnonKey
  ? createClient(supabaseUrl, supabaseAnonKey, {
      db: {
        schema: 'public',
      },
      global: {
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
        },
      },
    })
  : createClient('https://placeholder.supabase.co', 'placeholder-key');
```

**効果**:
- `Accept: application/json` ヘッダーを明示的に設定
- `Content-Type: application/json` ヘッダーも設定
- 406エラーを防ぐ

---

## ✅ 確認手順

1. **ブラウザをリロード**（F5）
2. **開発者ツール（F12）を開く**
3. **コンソールタブで確認**:
   - [ ] 406エラーが表示されない
   - [ ] 要約の保存が正常に動作する

4. **再度スキャンを実行**:
   - 「最新をチェック」ボタンをクリック
   - 新しい要約が正常に保存されることを確認

---

## 📝 補足説明

### `.single()` vs `.maybeSingle()`

- **`.single()`**: 結果が1件であることを期待。0件または2件以上の場合にエラーを返す
- **`.maybeSingle()`**: 結果が0件または1件であることを期待。0件の場合は `null` を返し、1件の場合はそのデータを返す

### 406エラーについて

406 (Not Acceptable) エラーは、サーバーがクライアントの要求を処理できないことを示します。SupabaseのREST APIでは、`Accept: application/json` ヘッダーが必要な場合があります。

---

## 🎯 次のステップ

修正が完了したら：

1. **ブラウザをリロード**
2. **再度スキャンを実行**
3. **エラーが解消されているか確認**

問題が解決しない場合は、コンソールのエラーメッセージを確認してください。


