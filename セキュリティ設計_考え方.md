# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®è€ƒãˆæ–¹

## ğŸ”’ ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### âœ… å®Ÿè£…æ¸ˆã¿ã®å¯¾ç­–

1. **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºåˆ¶é™**
   - WebSub callback: 1MBåˆ¶é™
   - å¤§é‡ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«ã‚ˆã‚‹æ”»æ’ƒã‚’é˜²æ­¢

2. **å…¥åŠ›æ¤œè¨¼ï¼ˆä¸€éƒ¨ï¼‰**
   - å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
   - HTTPãƒ¡ã‚½ãƒƒãƒ‰ã®æ¤œè¨¼

3. **ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨**
   - APIã‚­ãƒ¼ã‚’ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
   - ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥æ›¸ã‹ãªã„

4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ¶é™
   - å†…éƒ¨ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’å…¬é–‹ã—ãªã„

### âš ï¸ ç¾åœ¨ã®èª²é¡Œ

1. **èªè¨¼ãƒ»èªå¯ãŒãªã„**
   - èª°ã§ã‚‚APIã‚’å‘¼ã³å‡ºã›ã‚‹çŠ¶æ…‹
   - æ‚ªæ„ã®ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é˜²ã’ãªã„

2. **CORSãŒå…¨é–‹æ”¾**
   - `Access-Control-Allow-Origin: *`
   - ä»»æ„ã®ã‚µã‚¤ãƒˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒãªã„**
   - å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹æ”»æ’ƒï¼ˆDDoSï¼‰ã«è„†å¼±

4. **WebSub Callbackã®æ¤œè¨¼ä¸è¶³**
   - YouTubeã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã©ã†ã‹ã®æ¤œè¨¼ãŒãªã„
   - å½ã®é€šçŸ¥ã‚’é€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§

---

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®è€ƒãˆæ–¹

### **1. å¤šå±¤é˜²å¾¡ï¼ˆDefense in Depthï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤                â”‚
â”‚ - Vercelã®DDoSä¿è­·                      â”‚
â”‚ - IPåˆ¶é™ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤            â”‚
â”‚ - èªè¨¼ãƒ»èªå¯                            â”‚
â”‚ - ãƒ¬ãƒ¼ãƒˆåˆ¶é™                            â”‚
â”‚ - å…¥åŠ›æ¤œè¨¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ãƒ‡ãƒ¼ã‚¿å±¤                      â”‚
â”‚ - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®RLSï¼ˆRow Level Securityï¼‰â”‚
â”‚ - ç’°å¢ƒå¤‰æ•°ã®æš—å·åŒ–                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2. æœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆPrinciple of Least Privilegeï¼‰**

- **å¿…è¦ãªæ¨©é™ã ã‘ã‚’ä»˜ä¸**
- å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å¿…è¦ãªæ¨©é™ã‚’æ˜ç¢ºã«å®šç¾©

### **3. å…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ vs éå…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**

#### **å…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆèªè¨¼ä¸è¦ï¼‰**

```
/api/youtube/websub/callback
```
- **ç†ç”±**: YouTubeã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€èªè¨¼ãŒé›£ã—ã„
- **å¯¾ç­–**: 
  - WebSubã®æ¤œè¨¼ï¼ˆchallenge-responseï¼‰
  - ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºåˆ¶é™
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®RLSã§ä¿è­·

#### **éå…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆèªè¨¼å¿…è¦ï¼‰**

```
/api/youtube/poll
/api/youtube/jobs/process
/api/youtube/websub/subscribe
```
- **ç†ç”±**: ç®¡ç†è€…ã®ã¿ãŒå®Ÿè¡Œã™ã¹ãå‡¦ç†
- **å¯¾ç­–**: APIã‚­ãƒ¼èªè¨¼ã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼

---

## ğŸ” æ¨å¥¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### **1. APIã‚­ãƒ¼èªè¨¼ï¼ˆæ¨å¥¨ï¼‰**

#### **å®Ÿè£…æ–¹æ³•**

```typescript
// api/youtube/poll.ts
export default async function handler(req: Request): Promise<Response> {
  // APIã‚­ãƒ¼ã‚’æ¤œè¨¼
  const apiKey = req.headers.get('X-API-Key');
  const validApiKey = process.env.API_KEY;
  
  if (!apiKey || apiKey !== validApiKey) {
    return new Response(
      JSON.stringify({ error: 'Unauthorized' }),
      { status: 401, headers }
    );
  }
  
  // ä»¥é™ã®å‡¦ç†...
}
```

#### **ä½¿ç”¨æ–¹æ³•**

```bash
curl -X POST https://your-app.vercel.app/api/youtube/poll \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-secret-api-key" \
  -d '{"maxResults": 3}'
```

#### **ç’°å¢ƒå¤‰æ•°è¨­å®š**

```
API_KEY=your-secret-api-key-here
```

### **2. WebSub Callbackã®æ¤œè¨¼å¼·åŒ–**

#### **ç¾åœ¨ã®å®Ÿè£…**

```typescript
// è³¼èª­æ¤œè¨¼ã®ã¿ï¼ˆchallenge-responseï¼‰
const challengeResponse = websubService.verifySubscription(mode, topic, challenge);
```

#### **æ¨å¥¨æ”¹å–„**

```typescript
// 1. è³¼èª­æ¸ˆã¿ãƒãƒ£ãƒ³ãƒãƒ«ã®ã¿å—ã‘å…¥ã‚Œã‚‹
const { data: subscription } = await supabase
  .from('subscriptions')
  .select('*')
  .eq('topic_url', topic)
  .eq('status', 'subscribed')
  .single();

if (!subscription) {
  return new Response('Subscription not found', { status: 404 });
}

// 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨˜éŒ²ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
const clientIp = req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip');
console.log('WebSub request from:', clientIp);
```

### **3. CORSè¨­å®šã®æ”¹å–„**

#### **ç¾åœ¨ã®è¨­å®š**

```typescript
'Access-Control-Allow-Origin': '*',  // å…¨é–‹æ”¾
```

#### **æ¨å¥¨è¨­å®š**

```typescript
// è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’é™å®š
const allowedOrigins = [
  'https://your-app.vercel.app',
  'http://localhost:5173',  // é–‹ç™ºç’°å¢ƒã®ã¿
];

const origin = req.headers.get('origin');
const allowedOrigin = allowedOrigins.includes(origin || '') 
  ? origin 
  : 'null';

headers['Access-Control-Allow-Origin'] = allowedOrigin;
```

### **4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…**

#### **Vercel Edge Configã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰**

```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '1 m'), // 1åˆ†é–“ã«10ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
});

export default async function handler(req: Request): Promise<Response> {
  // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
  const ip = req.headers.get('x-forwarded-for') || 'unknown';
  
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
  const { success } = await ratelimit.limit(ip);
  
  if (!success) {
    return new Response(
      JSON.stringify({ error: 'Rate limit exceeded' }),
      { status: 429, headers }
    );
  }
  
  // ä»¥é™ã®å‡¦ç†...
}
```

#### **ç°¡æ˜“ç‰ˆï¼ˆãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ï¼‰**

```typescript
// ç°¡æ˜“çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§ã¯æ¨å¥¨ã—ãªã„ï¼‰
const requestCounts = new Map<string, { count: number; resetAt: number }>();

function checkRateLimit(ip: string): boolean {
  const now = Date.now();
  const record = requestCounts.get(ip);
  
  if (!record || now > record.resetAt) {
    requestCounts.set(ip, { count: 1, resetAt: now + 60000 }); // 1åˆ†
    return true;
  }
  
  if (record.count >= 10) {
    return false; // ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é
  }
  
  record.count++;
  return true;
}
```

### **5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®RLSï¼ˆRow Level Securityï¼‰**

#### **Supabaseã§RLSã‚’æœ‰åŠ¹åŒ–**

```sql
-- channelsãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSã‚’æœ‰åŠ¹åŒ–
ALTER TABLE channels ENABLE ROW LEVEL SECURITY;

-- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª­ã¿å–ã‚Šã®ã¿è¨±å¯
CREATE POLICY "Allow anonymous read"
ON channels FOR SELECT
TO anon
USING (true);

-- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ›¸ãè¾¼ã¿ä¸å¯
CREATE POLICY "Deny anonymous write"
ON channels FOR INSERT
TO anon
WITH CHECK (false);
```

### **6. ç’°å¢ƒå¤‰æ•°ã®ä¿è­·**

#### **Vercelã§ã®è¨­å®š**

1. Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Settings â†’ Environment Variables
2. ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆæš—å·åŒ–ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã‚‹ï¼‰
3. **é‡è¦**: `.env.local`ã‚’Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼ˆ`.gitignore`ã«è¿½åŠ æ¸ˆã¿ï¼‰

#### **æ©Ÿå¯†æƒ…å ±ã®ç®¡ç†**

- âœ… APIã‚­ãƒ¼: ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±: ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- âŒ ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥æ›¸ã‹ãªã„
- âŒ ãƒ­ã‚°ã«å‡ºåŠ›ã—ãªã„

---

## ğŸ“Š ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èªè¨¼ | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | CORS | å‚™è€ƒ |
|--------------|------|----------|------|------|
| `/api/youtube/websub/callback` | âŒ | âœ… | âœ… | YouTubeã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ |
| `/api/youtube/poll` | âœ… | âœ… | âœ… | ç®¡ç†è€…ã®ã¿ |
| `/api/youtube/jobs/process` | âœ… | âœ… | âœ… | Cronã‚¸ãƒ§ãƒ–ç”¨ |
| `/api/youtube/websub/subscribe` | âœ… | âœ… | âœ… | ç®¡ç†è€…ã®ã¿ |
| `/api/youtube/websub/resubscribe` | âœ… | âœ… | âœ… | Cronã‚¸ãƒ§ãƒ–ç”¨ |

---

## ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ

### **1. ç•°å¸¸ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œçŸ¥**

```typescript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã‚’è¨˜éŒ²
const logRequest = (req: Request, status: number) => {
  console.log(JSON.stringify({
    timestamp: new Date().toISOString(),
    method: req.method,
    url: req.url,
    ip: req.headers.get('x-forwarded-for'),
    status,
  }));
};
```

### **2. ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š**

- Vercelã®ãƒ­ã‚°ç›£è¦–
- ç•°å¸¸ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®æ¤œçŸ¥
- ã‚¨ãƒ©ãƒ¼ç‡ã®ç›£è¦–

### **3. ç·Šæ€¥æ™‚ã®å¯¾å¿œ**

1. **APIã‚­ãƒ¼ã®ç„¡åŠ¹åŒ–**
   - Vercelã®ç’°å¢ƒå¤‰æ•°ã‚’å‰Šé™¤
   - æ–°ã—ã„APIã‚­ãƒ¼ã‚’ç”Ÿæˆ

2. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä¸€æ™‚åœæ­¢**
   - Vercelã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - ã¾ãŸã¯ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³

---

## ğŸ”„ å®Ÿè£…ã®å„ªå…ˆé †ä½

### **å„ªå…ˆåº¦: é«˜ï¼ˆã™ãã«å®Ÿè£…ï¼‰**

1. âœ… **APIã‚­ãƒ¼èªè¨¼**
   - `/api/youtube/poll`
   - `/api/youtube/jobs/process`
   - `/api/youtube/websub/subscribe`
   - `/api/youtube/websub/resubscribe`

2. âœ… **CORSè¨­å®šã®æ”¹å–„**
   - è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’é™å®š

3. âœ… **WebSub Callbackã®æ¤œè¨¼å¼·åŒ–**
   - è³¼èª­æ¸ˆã¿ãƒãƒ£ãƒ³ãƒãƒ«ã®ã¿å—ã‘å…¥ã‚Œã‚‹

### **å„ªå…ˆåº¦: ä¸­ï¼ˆã§ãã‚‹ã ã‘æ—©ãï¼‰**

4. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**
   - å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å®Ÿè£…

5. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®RLS**
   - Supabaseã§è¨­å®š

### **å„ªå…ˆåº¦: ä½ï¼ˆæ™‚é–“ãŒã‚ã‚‹ã¨ãã«ï¼‰**

6. **ãƒ­ã‚°ç›£è¦–**
   - ç•°å¸¸æ¤œçŸ¥ã®ä»•çµ„ã¿

7. **IPåˆ¶é™**
   - å¿…è¦ã«å¿œã˜ã¦

---

## ğŸ“ ã¾ã¨ã‚

### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®åŸºæœ¬åŸå‰‡**

1. **å¤šå±¤é˜²å¾¡**: è¤‡æ•°ã®å¯¾ç­–ã‚’çµ„ã¿åˆã‚ã›ã‚‹
2. **æœ€å°æ¨©é™**: å¿…è¦ãªæ¨©é™ã ã‘ã‚’ä»˜ä¸
3. **å…¬é–‹ç¯„å›²ã®æ˜ç¢ºåŒ–**: å…¬é–‹/éå…¬é–‹ã‚’æ˜ç¢ºã«åˆ†ã‘ã‚‹
4. **ç¶™ç¶šçš„ãªæ”¹å–„**: å®šæœŸçš„ã«è¦‹ç›´ã—

### **ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³**

- âœ… åŸºæœ¬çš„ãªå¯¾ç­–ã¯å®Ÿè£…æ¸ˆã¿
- âš ï¸ èªè¨¼ãƒ»èªå¯ãŒä¸è¶³
- âš ï¸ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæœªå®Ÿè£…

### **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**

1. APIã‚­ãƒ¼èªè¨¼ã‚’å®Ÿè£…
2. CORSè¨­å®šã‚’æ”¹å–„
3. WebSub Callbackã®æ¤œè¨¼ã‚’å¼·åŒ–
4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£…ï¼ˆæ™‚é–“ãŒã‚ã‚‹ã¨ãã«ï¼‰

