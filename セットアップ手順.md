# Googleドキュメント主ストレージ設計 - セットアップ手順

## 📋 前提条件

- Node.js 22.14.0以上
- Supabaseアカウント（無料枠でOK）
- Google Cloud Consoleアカウント
- Vercelアカウント（デプロイ時）

---

## 1. Supabaseプロジェクトのセットアップ

### 1.1 Supabaseプロジェクト作成

1. [Supabase](https://supabase.com) にアクセスしてアカウント作成
2. 「New Project」をクリック
3. プロジェクト名を入力（例: `youtube-insight-hub`）
4. データベースパスワードを設定
5. リージョンを選択（日本: `ap-northeast-1`）
6. 「Create new project」をクリック

### 1.2 データベーススキーマ作成

1. Supabaseダッシュボードで「SQL Editor」を開く
2. `supabase-schema.sql` の内容をコピー＆ペースト
3. 「Run」をクリックして実行
4. テーブルが作成されたことを確認

### 1.3 APIキーの取得

1. Supabaseダッシュボードで「Settings」→「API」を開く
2. 以下の値をコピー：
   - **Project URL** (`VITE_SUPABASE_URL`)
   - **anon public** key (`VITE_SUPABASE_ANON_KEY`)

---

## 2. 環境変数の設定

### 2.1 ローカル開発環境

プロジェクトルートに `.env.local` ファイルを作成：

```env
# Supabase設定
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here

# Gemini API
VITE_GEMINI_API_KEY=your-gemini-api-key-here

# API Base URL（ローカル開発時は空欄でOK）
VITE_API_BASE_URL=
```

### 2.2 Vercelデプロイ時

1. Vercelダッシュボードでプロジェクトを開く
2. 「Settings」→「Environment Variables」を開く
3. 以下の環境変数を追加：

```
VITE_SUPABASE_URL = https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY = your-anon-key-here
VITE_GEMINI_API_KEY = your-gemini-api-key-here
SUPABASE_URL = https://your-project.supabase.co (Serverless Functions用)
SUPABASE_ANON_KEY = your-anon-key-here (Serverless Functions用)
```

**注意**: Vercel Serverless Functionsでは `process.env` を使用するため、`VITE_` プレフィックスなしの環境変数も必要です。

---

## 3. 依存関係のインストール

```bash
npm install
```

これで `@supabase/supabase-js` がインストールされます。

---

## 4. Google Cloud Console設定

### 4.1 OAuth 2.0 クライアントID作成

1. [Google Cloud Console](https://console.cloud.google.com) にアクセス
2. プロジェクトを作成または選択
3. 「APIとサービス」→「認証情報」を開く
4. 「+ 認証情報を作成」→「OAuth 2.0 クライアントID」を選択
5. アプリケーションタイプ: 「ウェブアプリケーション」
6. 承認済みのJavaScript生成元: 
   - ローカル: `http://localhost:3000`
   - 本番: `https://your-domain.vercel.app`
7. 承認済みのリダイレクトURI:
   - ローカル: `http://localhost:3000`
   - 本番: `https://your-domain.vercel.app`
8. 「作成」をクリック
9. **Client ID** をコピー

### 4.2 必要なAPIの有効化

以下のAPIを有効化：
- Google Drive API
- Google Docs API

---

## 5. Vercel Serverless Functionsの設定

### 5.1 APIエンドポイントの配置

Vercelでは、`api/` ディレクトリ内のファイルが自動的にServerless Functionsとしてデプロイされます。

現在の構成：
```
api/
├── channels.ts    # /api/channels エンドポイント
└── summaries.ts  # /api/summaries エンドポイント
```

### 5.2 vercel.jsonの確認

`vercel.json` が正しく設定されていることを確認：

```json
{
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

この設定により、APIエンドポイント以外のリクエストは `index.html` にリライトされます（SPA用）。

---

## 6. ローカル開発サーバーの起動

```bash
npm run dev
```

ブラウザで `http://localhost:3000` にアクセス。

---

## 7. 動作確認

### 7.1 チャンネル追加

1. サイドバーでチャンネル名または@ハンドルを入力
2. 「+」ボタンをクリック
3. チャンネルが追加されることを確認

### 7.2 Google認証

1. 「連携設定」でGoogle Client IDを入力
2. 「Googleと連携する」をクリック
3. Google認証画面でログイン
4. 「Google 接続済み」と表示されることを確認

### 7.3 動画スキャン

1. 「最新をチェック」ボタンをクリック
2. スキャンが実行されることを確認
3. 新しい要約が表示されることを確認
4. 各要約カードに「📄 要約をGoogleドキュメントで見る」ボタンが表示されることを確認

### 7.4 Googleドキュメント確認

1. 要約カードの「📄 要約をGoogleドキュメントで見る」ボタンをクリック
2. Googleドキュメントが開くことを確認
3. 要約内容が正しく保存されていることを確認

---

## 8. トラブルシューティング

### 8.1 Supabase接続エラー

**エラー**: `Supabase環境変数が設定されていません`

**解決方法**:
- `.env.local` ファイルが正しく作成されているか確認
- 環境変数名が正しいか確認（`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`）
- 開発サーバーを再起動

### 8.2 APIエンドポイント404エラー

**エラー**: `Failed to fetch` または `404 Not Found`

**解決方法**:
- Vercelにデプロイしている場合、`api/` ディレクトリが正しく配置されているか確認
- ローカル開発時は、Viteのプロキシ設定を確認（必要に応じて `vite.config.ts` を修正）

### 8.3 Google認証エラー（403）

**エラー**: `403 Forbidden` または認証画面でエラー

**解決方法**:
- Google Cloud ConsoleでOAuth設定を確認
- 承認済みのJavaScript生成元とリダイレクトURIが正しいか確認
- テストユーザーが追加されているか確認（開発中の場合）

### 8.4 Googleドキュメント作成エラー

**エラー**: `AccessToken missing` または `403 Forbidden`

**解決方法**:
- Google認証が完了しているか確認
- Google Drive API / Docs APIが有効化されているか確認
- OAuthスコープが正しく設定されているか確認

---

## 9. データ移行（既存のLocalStorageデータがある場合）

既存のLocalStorageデータをデータベースに移行する場合：

1. ブラウザの開発者ツールでLocalStorageを確認
2. `yt_insight_channels` と `yt_insight_summaries` のデータをエクスポート
3. 手動でデータベースにインポート、または移行スクリプトを作成

**注意**: 既存の要約データには `summary` と `keyPoints` が含まれていますが、新しい設計ではこれらはGoogleドキュメントに保存されます。既存データを移行する場合は、各要約に対してGoogleドキュメントを作成する必要があります。

---

## 10. デプロイ

### 10.1 Vercelへのデプロイ

1. GitHubリポジトリにプッシュ
2. Vercelダッシュボードで「New Project」をクリック
3. GitHubリポジトリをインポート
4. 環境変数を設定（上記参照）
5. 「Deploy」をクリック

### 10.2 デプロイ後の確認

1. デプロイされたURLにアクセス
2. Google Cloud ConsoleのOAuth設定を本番URLに更新
3. 動作確認を実施

---

## 📝 まとめ

Googleドキュメント主ストレージ設計の実装が完了しました。

**主な変更点**:
- ✅ データベースにメタデータのみ保存
- ✅ 要約内容はGoogleドキュメントに保存
- ✅ スキャン時に自動的にGoogleドキュメントを作成
- ✅ SummaryCardでGoogleドキュメントリンクを強調表示

**次のステップ**:
- 定期クローリング機能の実装
- Google Chat配信機能の実装
- Webhook機能の実装

