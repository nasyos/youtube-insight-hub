# é‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã®èª¬æ˜

## ğŸ” ç¾åœ¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®ä»•çµ„ã¿

### 1. ãƒã‚§ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

**`App.tsx`ã®`scanAllChannels`é–¢æ•°å†…**:

```typescript
for (const s of foundSummaries) {
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢ã«å–å¾—æ¸ˆã¿ã®å‹•ç”»ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  const exists = await api.current.checkVideoExists(s.url);
  if (exists) {
    console.log(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: æ—¢ã«å–å¾—æ¸ˆã¿ã®å‹•ç”» "${s.title}"`);
    continue; // ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã®å‹•ç”»ã¸
  }
  
  // é‡è¤‡ã—ã¦ã„ãªã„å ´åˆã®ã¿ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œ
  // 1. Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
  // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  // 3. Google Chatã«é€šçŸ¥
}
```

### 2. é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…

**`services/apiService.ts`ã®`checkVideoExists`ãƒ¡ã‚½ãƒƒãƒ‰**:

```typescript
async checkVideoExists(videoUrl: string): Promise<boolean> {
  if (USE_DIRECT_SUPABASE) {
    // Supabaseã«ç›´æ¥æ¥ç¶š
    const { data, error } = await supabase
      .from('summaries')
      .select('id')
      .eq('video_url', videoUrl)  // video_urlã‚«ãƒ©ãƒ ã§å®Œå…¨ä¸€è‡´æ¤œç´¢
      .maybeSingle();
    
    if (error && error.code !== 'PGRST116') {
      // PGRST116ã¯ã€Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã‚¨ãƒ©ãƒ¼ï¼ˆæ­£å¸¸ï¼‰
      console.warn('é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      return false; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯é‡è¤‡ã—ã¦ã„ãªã„ã¨åˆ¤æ–­
    }
    
    return !!data; // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°trueï¼ˆé‡è¤‡ï¼‰ã€ãªã‘ã‚Œã°false
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
  const summaries = await this.getSummaries();
  return summaries.some(s => s.url === videoUrl);
}
```

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆ¶ç´„

**`supabase-schema.sql`**:

```sql
CREATE TABLE IF NOT EXISTS summaries (
  id VARCHAR PRIMARY KEY,
  video_url VARCHAR UNIQUE NOT NULL,  -- UNIQUEåˆ¶ç´„ã§é‡è¤‡ã‚’é˜²ã
  ...
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§é«˜é€Ÿæ¤œç´¢
CREATE INDEX IF NOT EXISTS idx_summaries_video_url ON summaries(video_url);
```

---

## âš ï¸ é‡è¤‡ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹åŸå› 

### 1. URLã®å½¢å¼ãŒç•°ãªã‚‹

**å•é¡Œ**: YouTubeã®URLã«ã¯è¤‡æ•°ã®å½¢å¼ãŒã‚ã‚Šã¾ã™

- `https://www.youtube.com/watch?v=VIDEO_ID`
- `https://youtu.be/VIDEO_ID`
- `https://www.youtube.com/watch?v=VIDEO_ID&feature=share`
- `https://www.youtube.com/watch?v=VIDEO_ID&t=123`ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰

**ç¾åœ¨ã®å®Ÿè£…**: å®Œå…¨ä¸€è‡´ï¼ˆ`.eq('video_url', videoUrl)`ï¼‰ãªã®ã§ã€å½¢å¼ãŒç•°ãªã‚‹ã¨é‡è¤‡ã¨åˆ¤å®šã•ã‚Œã¾ã›ã‚“ã€‚

### 2. Gemini APIãŒç•°ãªã‚‹URLã‚’è¿”ã™

**å•é¡Œ**: Gemini APIãŒæ¤œç´¢çµæœã‹ã‚‰å–å¾—ã™ã‚‹URLãŒã€å®Ÿéš›ã®å‹•ç”»URLã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

**ä¾‹**:
- æ¤œç´¢çµæœ: `https://youtu.be/VIDEO_ID`
- å®Ÿéš›ã®URL: `https://www.youtube.com/watch?v=VIDEO_ID`

### 3. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®é•ã„

**å•é¡Œ**: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ`&feature=share`ã€`&t=123`ãªã©ï¼‰ãŒç•°ãªã‚‹ã¨ã€åˆ¥ã®URLã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚

---

## ğŸ”§ æ”¹å–„æ¡ˆ

### 1. URLæ­£è¦åŒ–é–¢æ•°ã®è¿½åŠ 

YouTubeã®URLã‚’æ­£è¦åŒ–ã—ã¦ã€VIDEO_IDã®ã¿ã§æ¯”è¼ƒã™ã‚‹æ–¹æ³•:

```typescript
function normalizeYouTubeUrl(url: string): string {
  // YouTube URLã‹ã‚‰VIDEO_IDã‚’æŠ½å‡º
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return match[1]; // VIDEO_IDã®ã¿ã‚’è¿”ã™
    }
  }
  
  return url; // ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã—ãªã„å ´åˆã¯å…ƒã®URLã‚’è¿”ã™
}
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«VIDEO_IDã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

```sql
ALTER TABLE summaries 
  ADD COLUMN IF NOT EXISTS video_id VARCHAR;

CREATE INDEX IF NOT EXISTS idx_summaries_video_id ON summaries(video_id);
```

### 3. é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®æ”¹å–„

```typescript
async checkVideoExists(videoUrl: string): Promise<boolean> {
  // URLã‚’æ­£è¦åŒ–ã—ã¦VIDEO_IDã‚’æŠ½å‡º
  const videoId = normalizeYouTubeUrl(videoUrl);
  
  if (USE_DIRECT_SUPABASE) {
    // VIDEO_IDã§æ¤œç´¢ï¼ˆã‚ˆã‚Šç¢ºå®Ÿï¼‰
    const { data, error } = await supabase
      .from('summaries')
      .select('id')
      .eq('video_id', videoId)  // VIDEO_IDã§æ¤œç´¢
      .maybeSingle();
    
    if (error && error.code !== 'PGRST116') {
      console.warn('é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
    
    return !!data;
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: URLã§ã‚‚ãƒã‚§ãƒƒã‚¯
  const summaries = await this.getSummaries();
  return summaries.some(s => {
    const existingVideoId = normalizeYouTubeUrl(s.url);
    return existingVideoId === videoId;
  });
}
```

---

## ğŸ› ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

### 1. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ç¢ºèª

é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’ç¢ºèª:

```
â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: æ—¢ã«å–å¾—æ¸ˆã¿ã®å‹•ç”» "ã‚¿ã‚¤ãƒˆãƒ«"
```

ã“ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã€é‡è¤‡ãƒã‚§ãƒƒã‚¯ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèª

Supabaseã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§`summaries`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª:

```sql
SELECT video_url, title, created_at 
FROM summaries 
ORDER BY created_at DESC 
LIMIT 10;
```

åŒã˜`video_url`ãŒè¤‡æ•°å­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### 3. ãƒ­ã‚°ã®è¿½åŠ 

`checkVideoExists`ãƒ¡ã‚½ãƒƒãƒ‰ã«ãƒ­ã‚°ã‚’è¿½åŠ :

```typescript
async checkVideoExists(videoUrl: string): Promise<boolean> {
  console.log('ğŸ” é‡è¤‡ãƒã‚§ãƒƒã‚¯:', videoUrl);
  
  if (USE_DIRECT_SUPABASE) {
    const { data, error } = await supabase
      .from('summaries')
      .select('id, video_url, title')
      .eq('video_url', videoUrl)
      .maybeSingle();
    
    console.log('ğŸ“Š æ¤œç´¢çµæœ:', { data, error });
    
    if (error && error.code !== 'PGRST116') {
      console.warn('é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
    
    const exists = !!data;
    console.log(exists ? 'âœ… é‡è¤‡ã‚ã‚Š' : 'âŒ é‡è¤‡ãªã—');
    return exists;
  }
  
  // ...
}
```

---

## ğŸ“‹ ç¢ºèªã™ã¹ããƒã‚¤ãƒ³ãƒˆ

1. **ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°**: `â­ï¸ ã‚¹ã‚­ãƒƒãƒ—`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹
2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: åŒã˜`video_url`ãŒè¤‡æ•°å­˜åœ¨ã—ã¦ã„ãªã„ã‹
3. **URLã®å½¢å¼**: Gemini APIãŒè¿”ã™URLã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹URLã®å½¢å¼ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹
4. **ã‚¨ãƒ©ãƒ¼**: é‡è¤‡ãƒã‚§ãƒƒã‚¯æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **URLæ­£è¦åŒ–é–¢æ•°ã‚’å®Ÿè£…**ï¼ˆæ¨å¥¨ï¼‰
2. **VIDEO_IDã‚«ãƒ©ãƒ ã‚’è¿½åŠ **ï¼ˆã‚ˆã‚Šç¢ºå®Ÿï¼‰
3. **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ **ã—ã¦å•é¡Œã‚’ç‰¹å®š
4. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèª**ã—ã¦é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®æœ‰ç„¡ã‚’ç¢ºèª

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€URLã®å®Œå…¨ä¸€è‡´ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ãŸã‚ã€URLã®å½¢å¼ãŒç•°ãªã‚‹ã¨é‡è¤‡ã¨åˆ¤å®šã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

